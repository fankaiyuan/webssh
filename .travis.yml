sudo: required
addons:
  apt:
    update: true
    packages:
      - docker-ce
services:
  - docker
script:
  - export DOCKER_CLI_EXPERIMENTAL=enabled
  - source sha_function.sh
  - flag_alpine=$(is_base "treehouses/alpine:latest" "kaiyfan/webssh:latest")
  - echo $flag_alpine
#  - version2=$(image_version treehouses/webssh:latest)
#  - echo "treehouses version is $version2"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
  - "./docker-build.sh treehouses/alpine:latest arm"
  - flag=$(compare "treehouses/alpine:latest" "kaiyfan/webssh:latest")
  - echo $flag
before_deploy:
  - tag_time=$(date +%Y%m%d%H%M)
  - echo $tag_time
  - tag_latest="latest"
  - tag_time=$timetag
  - echo $tag_time
  - create_manifest kaiyfan/webssh $tag1 $tag2 kaiyfan/webssh-tags:arm
  - docker manifest inspect kaiyfan/webssh:$tag_latest
  - docker manifest inspect kaiyfan/webssh:$tag_time
deploy:
  - provider: script
    script: docker manifest push kaiyfan/webssh:$tag_latest; docker manifest push kaiyfan/webssh:$tag_time
    skip_cleanup: true
    on:
      all_branches: true
      condition: "$flag = true"
env:
  global:
    secure: AAAAB3NzaC1yc2EAAAADAQABAAACAQDDXvzPkwNwYKXgjWemRbh+K8GtQFreQMDZx/Isdrc1s7TLurWWlXPp/AE5X09xglTZeq+kWgKDXHKCGuP9fiq7Jmao8MvCMnqmS9uQOlOEe5C9JkVrUuQFt3EG0BT6ZOdfSRJUBxzSe5Kb+VSzI6isGXpXixH+B924bK9Hdr8wgRxckrKC81RnOid7H/FkxHgbgQ4zuVbHoMmKxyne+L0s+TZLDEn3z/KEZJzAE5HzKU+JdN5bDNJWINIcvHQfSDekCK3NwdqRhRGJo/WN0lbVcxx0+db3PaPfPXrDyh32JON4S5suBQQEOS2pRvnOiiZj41LySdAK2esi96xYpZp/JrcYqdOAkbuVHOp/VWCW73bvEEgu2gxtnkLz7NbG6Wt1DEa1BM/nHt9TMcptDDlBFhXz0pkjRp8g7Jvravrw8BaX0Xn+tCU4enGIqRBraYitD4VaKsTnanammxxQa+AUpLM3IYKOmgVHh9ift+CCXwzBkEUCJn71ANXKhF53qd4TzaS1lRn27TIRCB+2ACTJ1yxxfF1gYKFAGmpEUmR1utaStokO+xPOFZVoLfuGNFwfOTVMNpI4kFlJ6bPAL4KskB+EYCQ3NxnF5Y9iXFhw4LrRIYyv1XalhkK+t3HAZJM0in4ED7VhrMijYVh9Oj+mTQuR82xWq9vzUvKDxjwEhw==
